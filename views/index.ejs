<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Plaid Transaction</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- <link rel="stylesheet" href="https://threads.plaid.com/threads.css"> -->

  <!-- Firebase Inclusion -->
  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>
  <!-- Firebase services added: authentication, database -->
  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-database.js"></script>
  <!-- Initialize Firebase -->
  <!-- Firebase Inclusion -->
  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>
  <!-- Firebase services added: authentication, database -->
  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-database.js"></script>
  <script src="https://cdn.firebase.com/libs/firebaseui/3.1.1/firebaseui.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.1.1/firebaseui.css" />
  <!-- Initialize Firebase -->
  <script>
    var config = {
        apiKey: "AIzaSyBiqwDiXaTG3-qqRjrMybgdXMikDP6tmSk",
        authDomain: "gt-coding-project-1.firebaseapp.com",
        databaseURL: "https://gt-coding-project-1.firebaseio.com",
        projectId: "gt-coding-project-1",
        storageBucket: "gt-coding-project-1.appspot.com",
        messagingSenderId: "705133084492"
        };
    firebase.initializeApp(config);

    var database = firebase.database();

    // Initialize the FirebaseUI Widget using Firebase.
    var access_token;
    var publicToken;
    var item_id;
    var remainingMoney = 0;
    var ui = new firebaseui.auth.AuthUI(firebase.auth());
        // Config for firebase auth UI
        var uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                // User successfully signed in.
                // Return type determines whether we continue the redirect automatically
                // or whether we leave that to developer to handle.
                return true;
                },
                uiShown: function() {
                // The widget is rendered.
                // Hide the loader.
                document.getElementById('loader').style.display = 'none';
                }
            },
            // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
            signInFlow: 'popup',
            signInSuccessUrl: '/index',
            signInOptions: [
                // Leave the lines as is for the providers you want to offer your users.
                firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                firebase.auth.EmailAuthProvider.PROVIDER_ID,
            ],
            // Terms of service url.
            tosUrl: '#',
            // Privacy policy url.
            privacyPolicyUrl: '#'
        };
        
    </script>
  <!-- Bring in Firebase UI -->
  <script src="https://cdn.firebase.com/libs/firebaseui/3.1.1/firebaseui.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.1.1/firebaseui.css" />

  <link rel="stylesheet" type="text/css" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <div class="login-modal w-100 h-100" style="z-index: 10000">
    <main>
      <div id="Banner" class="row card-panel teal lighten-3"></div>

      <div class="container row">
        <img src="/images/Pail_Logo.png" height="125px">
      </div>

      <br>

      <!-- firebase ui here -->
      <div id="firebaseui-auth-container" class="col s2 offset-s3">
        <!-- loader here -->
        <div id="loader" class="col s2 offset-s3">Loading...</div>
      </div>

      <div class="row wrapper center">
        <button class=" btn-small btn-submit waves-effect waves-light teal scale-transition" id="loginButton">
          Log in without Sign-on
        </button>
      </div>

      <footer class="page-footer teal wrapper">
        <div class="container">
          <div class="row">
            <div>
              <h5 class="white-text">Footer Content</h5>
            </div>
          </div>
        </div>
        <div class="footer-copyright">
          <div class="container">
            Â© 2014 Copyright Text
          </div>
        </div>
      </footer>


    </main>


  </div>
  <div class="container" style="display: none">
    <div class="grid">
      <div class="grid__column grid__column--is-twelve-columns">
        <div id="banner" class="everpresent-content">
          <img src="/assets/Pail_Logo.png" width="100" height="auto">
          <p id="intro" class="everpresent-content__subheading">
            Welcome to Pail! Connect your bank account to get the most out of Pail.
          </p>
          <p id="steps" class="everpresent-content__subheading">
            Success! You linked your account.
          </p>
        </div>

        <div id="container" class="initial-view">
          <p class="initial-view__description">
            Click the button below to open a list of Institutions. Select your bank and the accounts you would like to
            link.
          </p>

          <button id="link-btn" class="waves-effect waves-light btn"><i class="material-icons right">attach_money</i>Connect
            Your Account</button>
        </div>
      </div>
    </div>


    <div id="app" class="connected-view">

      <!-- Card that displays budget -->
      <div class="row" id="budget-card">
        <div class="col s12 m12">
          <div class="card teal lighten-2">
            <div class="card-content white-text">
              <span class="card-title">Your Monthly Budget</span>
              <span id="budget-card-body"></span>
              <div id="budget-details" class="card-action"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card that displays transactions to be sorted as discretionary or recurring -->
      <div class="row" id="set-transactions-card">
        <div class="col s12 m12">
          <div class="card teal lighten-2">
            <div class="card-content white-text">
              <span class="card-title">Excellent! Your monthly budget has been set to <span id="budget-set"></span>!</span>
              <p>Click the button below to load transactions from this month. Next, select transactions that
                should be included in the Discretionary budget. Only Discretionary transactions will be tracked in your
                budget.</p>
            </div>
            <div id="card-action" class="card-action">
              <button id="get-transactions-btn" class="waves-effect waves-light btn">Get Transactions</button>
              <table>
                <tbody id="get-transactions-data"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>


      <!-- Card to set you budget -->
      <div class="row" id="set-budget-card">
        <div class="col s12 m12">
          <div class="card teal lighten-2">
            <div class="card-content white-text">
              <span class="card-title">Your Budget</span>
              <p>Use the slider to create your budget. Estimate your monthly amount of discretionary spending.</p>
              <br>
              <form action="#">
                <p class="range-field">
                  <input type="range" id="budget-amount" min="25" max="3000" />
                </p>
              </form>
            </div>
            <div class="card-action">
              <button id="submit-budget" class="waves-effect waves-light btn">Submit</button>
            </div>
          </div>
        </div>
      </div>




    </div>

  </div>


  <!-- Start inline Javscript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    $('#loginButton').on('click', function () {
      window.location = '/index';
    });

    // The start method will wait until the DOM is loaded.
    ui.start('#firebaseui-auth-container', {
      signInOptions: [
        firebase.auth.EmailAuthProvider.PROVIDER_ID,
        firebase.auth.GoogleAuthProvider.PROVIDER_ID
      ],
      // Other config options...
    });
    ui.start('#firebaseui-auth-container', uiConfig);
  </script>
  <script>
    // GLOBAL VARS
    var budget = 0;
    var spentMoney = 0;
    var spendCats = [];
    var transObj = {};


    (function ($) {
      var products = '<%= PLAID_PRODUCTS %>'.split(',');
      if (products.includes('assets')) {
        $('#assets').show();
      }

      var handler = Plaid.create({
        apiVersion: 'v2',
        clientName: 'Plaid Quickstart',
        env: '<%= PLAID_ENV %>',
        product: products,
        key: '<%= PLAID_PUBLIC_KEY %>',
        // webhook: 'https://your-domain.tld/plaid-webhook',
        onSuccess: function (public_token) {
          $.post('/get_access_token', {
            public_token: public_token
          }, function (data) {
            publicToken = public_token
            $('#container').fadeOut('fast', function () {
              $('#item_id').text(data.item_id);
              item_id = data.item_id;
              $('#access_token').text(data.access_token);
              access_token = data.access_token;
              $('#intro').hide();
              $('#app, #steps').fadeIn('slow');
            });
          });
        },
      });
      var accessToken = qs('access_token');
      if (accessToken != null && accessToken != '') {
        $.post('/set_access_token', {
          access_token: accessToken
        }, function (data) {
          $('#container').fadeOut('fast', function () {
            $('#item_id').text(data.item_id);
            $('#access_token').text(accessToken);
            $('#intro').hide();
            $('#app, #steps').fadeIn('slow');
          });
        });
      }

      $('#link-btn').on('click', function (e) {
        handler.open();
      });

      // $('#get-accounts-btn').on('click', function (e) {
      //   $.get('/accounts', function (data) {
      //     $('#get-accounts-data').slideUp(function () {
      //       var html = '<tr><td><strong>Name</strong></td><td><strong>Balances</strong></td><td><strong>Subtype</strong></td><td><strong>Mask</strong></td></tr>';
      //       data.accounts.accounts.forEach(function (account, idx) {
      //         html += '<tr>';
      //         html += '<td>' + account.name + '</td>';
      //         html += '<td>$' + (account.balances.available != null ? account.balances.available : account.balances.current) + '</td>';
      //         html += '<td>' + account.subtype + '</td>';
      //         html += '<td>' + account.mask + '</td>';
      //         html += '</tr>';
      //       });

      //       $(this).html(html).slideDown();
      //     });
      //   });
      // });

      // $('#get-auth-btn').on('click', function (e) {
      //   $.get('/auth', function (data) {
      //     $('#get-auth-data').slideUp(function () {
      //       var authData = data.auth;
      //       var isAch = authData.numbers.ach.length > 0;
      //       var routingLabel = isAch ? 'Routing #' : 'Institution and Branch #';

      //       var html = '<tr><td><strong>Name</strong></td><td><strong>Balance</strong></td><td><strong>Account #</strong></td><td><strong>' + routingLabel + '</strong></td></tr>';
      //       if (isAch) {
      //         authData.numbers.ach.forEach(function (achNumbers, idx) {
      //           // Find the account associated with this set of account and routing numbers
      //           var account = authData.accounts.filter(function (a) {
      //             return a.account_id == achNumbers.account_id;
      //           })[0];
      //           html += '<tr>';
      //           html += '<td>' + account.name + '</td>';
      //           html += '<td>$' + (account.balances.available != null ? account.balances.available : account.balances.current) + '</td>';
      //           html += '<td>' + achNumbers.account + '</td>';
      //           html += '<td>' + achNumbers.routing + '</td>';
      //           html += '</tr>';
      //         });
      //       } else {
      //         authData.numbers.eft.forEach(function (eftNumber, idx) {
      //           // Find the account associated with this set of account and routing numbers
      //           var account = authData.accounts.filter(function (a) {
      //             return a.account_id == eftNumber.account_id;
      //           })[0];
      //           html += '<tr>';
      //           html += '<td>' + account.name + '</td>';
      //           html += '<td>$' + (account.balances.available != null ? account.balances.available : account.balances.current) + '</td>';
      //           html += '<td>' + eftNumber.account + '</td>';
      //           html += '<td>' + eftNumber.institution + ' ' + eftNumber.branch + '</td>';
      //           html += '</tr>';
      //         });
      //       }
      //       $(this).html(html).slideDown();
      //     });
      //   });
      // });

      // $('#get-identity-btn').on('click', function (e) {
      //   $.get('/identity', function (data) {
      //     $('#get-identity-data').slideUp(function () {
      //       var identityData = data.identity.identity;
      //       var html = '<tr class="response-row response-row--is-identity"><td><strong>Names</strong></td><td><strong>Emails</strong></td><td><strong>Phone numbers</strong></td><td><strong>Addresses</strong></td></tr><tr class="response-row response-row--is-identity">';
      //       html += '<td>';
      //       identityData.names.forEach(function (name, idx) {
      //         html += name + '<br />';
      //       });
      //       html += '</td><td>';
      //       identityData.emails.forEach(function (email, idx) {
      //         html += email.data + '<br />';
      //       });
      //       html += '</td><td>';
      //       identityData.phone_numbers.forEach(function (number, idx) {
      //         html += number.data + '<br />';
      //       });
      //       html += '</td><td>';
      //       identityData.addresses.forEach(function (address, idx) {
      //         html += address.data.street + '<br />';
      //         html += address.data.city + ', ' + address.data.state + ' ' + address.data.zip;
      //       });
      //       html += '</td></tr>';

      //       $(this).html(html).slideDown();
      //     });
      //   });
      // });

      // $('#get-item-btn').on('click', function (e) {
      //   $.get('/item', function (data) {
      //     $('#get-item-data').slideUp(function () {
      //       if (data.error)
      //         $(this).html('<p>' + data.error + '</p>').slideDown();
      //       else {
      //         console.log(data);
      //         var html = '';
      //         html += '<tr><td>Institution name</td><td>' + data.institution.name + '</td></tr>';
      //         html += '<tr><td>Billed products</td><td>' + data.item.billed_products.join(', ') + '</td></tr>';
      //         html += '<tr><td>Item ID</td><td>' + data.item.item_id + '</td></tr>';
      //         html += '<tr><td>Available products</td><td>' + data.item.available_products.join(', ') + '</td></tr>';

      //         $(this).html(html).slideDown();
      //       }
      //     });
      //   });
      // });

      $('#get-transactions-btn').on('click', function (e) {
        $.get('/transactions', function (data) {
          if (data.error != null && data.error.error_code != null) {
            // Format the error
            var errorHtml = '<div class="inner"><p>' +
              '<strong>' + data.error.error_code + ':</strong> ' +
              (data.error.display_message == null ? data.error.error_message : data.error.display_message) +
              '</p></div>';

            if (data.error.error_code === 'PRODUCT_NOT_READY') {
              // Add additional context for `PRODUCT_NOT_READY` errors
              errorHtml += '<div class="inner"><p>Note: The PRODUCT_NOT_READY ' +
                'error is returned when a request to retrieve Transaction data ' +
                'is made before Plaid finishes the <a href="https://plaid.com/' +
                'docs/quickstart/#transaction-data-with-webhooks">initial ' +
                'transaction pull.</a></p></div>';
            }
            // Render the error
            $('#get-transactions-data').slideUp(function () {
              $(this).slideUp(function () {
                $(this).html(errorHtml).slideDown();
              });
            });
          } else {
            transObj = data.transactions.transactions
            console.log(transObj);
            $('#get-transactions-btn').fadeOut();
            $('#get-transactions-data').slideUp(function () {
              var i = 0;
              var html =
                '<tr><td><strong>Name</strong></td><td><strong>Amount</strong></td><td><strong>Date</strong></td><td><strong>Include in Budget?</strong></td></tr>';
              data.transactions.transactions.forEach(function (txn, idx) {
                html += '<tr>';
                html += '<td>' + txn.name + '</td>';
                html += '<td>$' + txn.amount + '</td>';
                html += '<td>' + txn.date + '</td>';
                html += '<td>' + "<button data-num=" + i + " data-txn=" + txn.amount +
                  " id='include-btn' class='waves-effect waves-light btn teal darken-3'>Include</button>" +
                  '</td>';
                html += '</tr>';
                i++;
              });
              var button = $('<button>').text("Complete");
              button.attr("class", "waves-effect waves-light btn teal darken-3");
              button.attr("id", "submit-tran-btn");
              $("#card-action").append(button);

              $(this).slideUp(function () {
                $(this).html(html).slideDown();
              });
            });
          }
        });
      });




      // $('#get-balance-btn').on('click', function (e) {
      //   $.get('/balance', function (data) {
      //     $('#get-balance-data').slideUp(function () {
      //       var balanceData = data.balance;
      //       var html = '<tr><td><strong>Name</strong></td><td><strong>Balance</strong></td><td><strong>Subtype</strong></td><td><strong>Mask</strong></td></tr>';
      //       balanceData.accounts.forEach(function (account, idx) {
      //         html += '<tr>';
      //         html += '<td>' + account.name + '</td>';
      //         html += '<td>$' + (account.balances.available != null ? account.balances.available : account.balances.current) + '</td>'
      //         html += '<td>' + account.subtype + '</td>';
      //         html += '<td>' + account.mask + '</td>';
      //         html += '</tr>';
      //       });

      //       $(this).html(html).slideDown();
      //     });
      //   });
      // });

      // $('#get-assets-btn').on('click', function (e) {
      //   $.get('/assets', function (data) {
      //     $('#get-assets-data').slideUp(function () {
      //       var reportData = data.json;
      //       var html = `
      //     <tr>
      //       <td><strong>Account</strong></td>
      //       <td><strong>Balance</strong></td>
      //       <td><strong># Transactions</strong></td>
      //       <td><strong># Days Available</strong></td>
      //     </tr>`;
      //       reportData.items.forEach(function (item, itemIdx) {
      //         item.accounts.forEach(function (account, accountIdx) {
      //           html += '<tr>';
      //           html += '<td>' + account.name + '</td>';
      //           html += '<td>$' + account.balances.current + '</td>'
      //           html += '<td>' + account.transactions.length + '</td>';
      //           html += '<td>' + account.days_available + '</td>';
      //           html += '</tr>';
      //         });
      //       });

      //       $('#download-assets-pdf-btn')
      //         .attr('href', `data:application/pdf;base64,${data.pdf}`)
      //         .attr('download', 'Asset Report.pdf')
      //         .show();

      //       $(this).html(html).slideDown();
      //     });
      //   });
      // });
    })(jQuery);

    function qs(key) {
      key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
      var match = location.search.match(new RegExp("[?&]" + key + "=([^&]+)(&|$)"));
      return match && decodeURIComponent(match[1].replace(/\+/g, " "));
    }

    // Submits the users selected budget, fades out card.
    $('#submit-budget').on('click', function () {
      budget = parseInt($('#budget-amount').val());
      console.log(budget);
      $('#set-budget-card').fadeOut();
      $('#budget-set').text("$" + budget);
      $('#set-transactions-card').fadeIn();

      if (uid && access_token && publicToken && item_id) {
        $(".modal").hide();
        database.ref("/users/"+uid).push({
            "accessToken": access_token,
            "publicToken": publicToken,
            "itemID": item_id,
            "remaining": remainingMoney,
            "budget": budget
        });
      };
    });

    // Function to include transaction in budge
    $(document).on("click", "#include-btn", function () {
      spentMoney = spentMoney + parseInt($(this).attr("data-txn"));
      console.log(spentMoney);

      var newCats = transObj[$(this).attr('data-num')].category;
      // console.log(newCats);

      spendCats = (spendCats.concat(newCats));
      console.log(spendCats);


      $(this).closest('tr').fadeOut();
    });

    // Shows budget card on click.
    $(document).on('click', '#submit-tran-btn', function () {
      $("#steps").fadeOut();
      $("#set-transactions-card").fadeOut();
      $("#budget-card").fadeIn();

      var budgetGraph = $('<div>');
      budgetGraph.attr("id", "budget-graph");
      budgetGraph.attr("class", "center-align teal darken-3");


      $('#budget-card-body').append(budgetGraph);

      var budgetSpent = $('<div>');
      budgetSpent.attr('id', 'budget-remaining');
      budgetSpent.attr("class", "center-align teal darken-1");

      if (spentMoney / budget * 400 < 400) {
        var height = spentMoney / budget * 400;
      } else {
        var height = 400;
      }

      if (height < 54) {
        height = 53;
      } else {
        budgetSpent.height(height);
      }

      if (400 - height < 54) {
        budgetGraph.height(height + 53);
      } else if (height >= 400) {
        budgetGraph.height(400);

      } else {
        budgetGraph.height(400);
      }

      if (spentMoney > 0) {
        budgetSpent.append($("<p id= 'money-text'>").text('($' + spentMoney + ')'));
      }

      budgetGraph.append(budgetSpent);

      remainingMoney = budget - spentMoney
      budgetGraph.append($("<p id= 'remaining-text'>").text('$' + remainingMoney));


      $('#budget-details').text("You have spent $" + spentMoney + " so far this month, and have $" + remainingMoney +
        " left in you budget.")

    });

    var uid = null;
    // firebase sign in success hides modal
    firebase.auth().onAuthStateChanged((user) => {
      // hide modal
      uid = user.uid;
    });
  </script>
</body>

</html>